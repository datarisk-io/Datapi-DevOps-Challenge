name: 'send-dockerfile'
on:
  pull_request:
    branches: [ "develop" ]
  workflow_dispatch:

env:
  NAME_BUILD: "datarisk"
  LOWERCASE_REPO_NAME: "${{ github.repository }} | tr '[:upper:]' '[:lower:]'"

jobs:
  build:
    name: 'send-dockerfile'
    runs-on: ubuntu-latest   
    defaults:
      run:
        shell: bash
        working-directory: projeto-fsharp

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Login Docker Repository 
        uses: azure/docker-login@v1
        with:
          login-server: ghcr.io
          username: ${{ github.actor }} 
          password: ${{ secrets.TOKEN_GIT }}
  
      - name: Build Docker Image
        run: docker build -t ghcr.io/${{ env.LOWERCASE_REPO_NAME }}/${{ env.NAME_BUILD }}:latest -f Dockerfile .

      - name: Tag Docker image with lasted and tag version
        run: |
          docker tag ${{ env.NAME_BUILD }} ghcr.io/${{ env.LOWERCASE_REPO_NAME }}/${{ env.NAME_BUILD }}:latest 
          docker tag ${{ env.NAME_BUILD }} ghcr.io/${{ env.LOWERCASE_REPO_NAME }}/${{ env.NAME_BUILD }}:${{github.sha}}
  
      - name: Push to GitHub Container Registry, lasted and tag version
        run: |
          docker push ghcr.io/${{ env.LOWERCASE_REPO_NAME }}/${{ env.NAME_BUILD }}:latest 
          docker push ghcr.io/${{ env.LOWERCASE_REPO_NAME }}/${{ env.NAME_BUILD }}:${{github.sha}} 